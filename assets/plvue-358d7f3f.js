function q(t){return Object.prototype.toString.call(t).slice(8,-1).toLowerCase()}function m(t){return["object","array"].includes(q(t))}function dt(t,r){return Object.prototype.hasOwnProperty.call(t,r)}function B(t,r){if(m(t)&&m(r)){const e=Object.keys(t),n=Object.keys(r);if(e.length!==n.length)return!1;for(const o of e)if(!n.includes(o)||!B(t[o],r[o]))return!1;return!0}else return t===r}function g(t){return q(t)==="object"}function V(t){return Array.isArray(t)}function W(t){return typeof t=="string"}function x(t){Promise.resolve().then(t)}function ht(){return Number(Math.random().toString().slice(2)).toString(32)}function S(...t){console.warn(...t)}let R=null;const _=new WeakMap;function P(t){R=t,t(),R=null}function pt(t){const r=_.get(t)||[],e=r.some(n=>R===n);R&&!e&&(r.push(R),_.set(t,r))}function J(t){const r=_.get(t);r&&r.forEach((e,n)=>{const o=e();typeof o=="boolean"&&o&&(r.splice(n,1),_.set(t,r))})}const gt=new WeakMap,D=new WeakMap,X={RAW:Symbol("__v_raw"),IS_READONLY:Symbol("__v_isReadonly")};function U(t){if(!m(t)||Object.isFrozen(t))return S(`lue cannot be made reactive: ${t}`),t;if(gt.get(t))return t;let r=null;return new Proxy(t,{get(e,n,o){if(n===X.RAW)return e;if(m(e[n]))return U(e[n]);const c=Reflect.get(e,n,o);return pt(e),c},set(e,n,o,c){if(e[X.IS_READONLY])return!0;if(m(e[n])){const f=e[n],l=new Set;for(const a in o)l.add(a),this.set(f,a,o[a],c[n]);for(const a in f)l.has(a)||this.deleteProperty(f,a);return!0}if(Reflect.get(e,n,c)===o)return!0;const s=Reflect.set(e,n,o,c),u=D.get(e)||new Set;u.add(n);const h=u.size;return D.set(e,u),x(()=>{const f=Reflect.get(e,n,c);s&&f===o&&h===1&&J(e),D.delete(e)}),s},deleteProperty(e,n){const o=Reflect.get(e,n);if(m(o)){for(const s in o)this.deleteProperty(o,s);return!0}const c=dt(e,n),i=Reflect.deleteProperty(e,n);return r=n,x(()=>{c&&i&&o!==void 0&&n===r&&(J(e),r=null)}),i}})}const E=function(){const t=new WeakMap,r=["null","weakset","weakmap"],e={set(n){const o=new Set;for(const c of n)o.add(E(c));return o},map(n){const o=new Map;for(const[c,i]of n.entries())o.set(c,E(i));return o}};return function(n){const o=q(n);if(typeof n!="object"||r.includes(o))return n;if(t.has(n))return t.get(n);if(e[o])return e[o](n);const c=V(n)?[]:{};Object.setPrototypeOf(c,Object.getPrototypeOf(n)),t.set(n,c);for(const i in n)c[i]=E(n[i]);return c}}();function $(t,r){return Object.assign({},t,r)}function yt(t,r,e={}){let n=!1;if(n)return;const o=t();e.immediate&&r(o,void 0);let c=E(o),i=!0;return P(()=>{const s=t();if(m(s)){e.deep&&!B(s,c)&&(r(s,c),c=E(s));return}if(i){i=!1;return}r(s,c),c=s}),()=>{n=!0}}function j(t){return["string","number"].includes(typeof t)&&t!==""}function mt(t){return!/^on/.test(t)}function K(t){return g(t)&&(W(t.tag)||T(t.tag))}function d(t){return typeof t=="function"&&!T(t)}function z(t){return[void 0,null,"",!0,!1].includes(t)}function M(t){return document.createTextNode(t)}function p(t,r,...e){const n={tag:t,attrs:r||{},children:e};return d(n.tag)&&n.children.length===0&&n.attrs.children&&(n.children=n.attrs.children),n}function Y({children:t}){return t}const k=Symbol("Fragment");Y.prototype[k]=k;function T(t){return typeof t=="function"&&t.prototype[k]===k}const Z=[];function v(){Z.forEach(t=>{t()}),Z.length=0}const ct=new WeakMap;function it(t,r=[]){return t.forEach(e=>{g(e)&&(d(e.tag)?r.push({comp:e.tag,compId:e.tag.prototype._id,props:$(e.attrs,{children:t})}):j(e.tag)&&it(e.children,r))}),r}function H(t,r=[]){const e=ct.get(t)||[];return r.push(...e),e.forEach(n=>{const o=H(n.comp);r.push(...o)}),r}const bt=new Map;function tt(t){const r=H(t).map(n=>n.compId);r.unshift(t.prototype._id);const e=[];r.forEach(n=>{const o=bt.get(n)||[];e.push(...o)}),e.forEach(n=>{n()})}const et=[];function wt(){et.forEach(t=>{t()}),et.length=0}const Rt=new Map;function nt(t){const r=H(t).map(n=>n.compId);r.unshift(t.prototype._id);const e=[];r.forEach(n=>{const o=Rt.get(n)||[];e.push(...o)}),e.forEach(n=>{n()})}function b(t,r,e){if(W(t))return Q(t,r,e);if(T(t))return A(e);if(d(t)){const n=$(r,{children:e});t.prototype._id=ht();const o=t(n);return j(o)?M(o):(ct.set(t,it(o.children)),b(o.tag,o.attrs,o.children))}}function Q(t,r={},e=[""]){if(T(t))return b(t,r,e);const n=document.createElement(t);e.forEach(o=>{if(!z(o)){if(j(o)){const c=M(o);c.nodeValue=o,n.appendChild(c);return}if(typeof o=="function"){const c=A([o]);n.appendChild(c);return}if(V(o)){const c=A(o);n.appendChild(c);return}if(K(o)){const c=Q(o.tag,o.attrs,o.children);n.appendChild(c);return}if(g(o)&&d(o.tag)){const c=b(o.tag,o.attrs,o.children);n.appendChild(c);return}S(`render: 不支持 ${o} 值渲染`)}});for(const o in r){const c=r[o];n[o]=c,o==="ref"&&(c.value=n),typeof c=="function"&&mt(o)&&P(()=>{n[o]=c()})}if(r.style&&g(r.style))for(const o in r.style){const c=r.style[o];typeof c=="function"?P(()=>n.style[o]=c()):n.style[o]=c}return n}function A(t){const r=document.createDocumentFragment();return t.forEach(e=>{if(!z(e)){if(j(e)){const n=M(e);n.nodeValue=e,r.appendChild(n);return}if(typeof e=="function"){Et(r,e);return}if(V(e)){const n=A(e);r.appendChild(n);return}if(K(e)){const n=Q(e.tag,e.attrs,e.children);r.appendChild(n);return}if(g(e)&&d(e.tag)){const n=b(e.tag,e.attrs,e.children);r.appendChild(n);return}S(`render: 不支持 ${e} 值渲染`)}}),r}function rt(t){if(j(t))return M(t);if(K(t)||g(t)&&d(t.tag))return b(t.tag,t.attrs,t.children)}function Et(t,r){let e=[],n=!0,o=null;const c=M("");t.appendChild(c),P(()=>{let i=r();if(i&&g(i)&&T(i.tag)){S("不支持响应式节点片段渲染");return}V(i)||(i=[i]),i=i.filter(u=>!z(u));let s=0;for(;s<i.length;){let u=i[s];const h=s,f=e.findIndex(l=>l.key===h);if(f>=0){if(B(u,e[f].tree)){s++;continue}const l=rt(u);if(!l){i.splice(f,1),s++;continue}const a=e[f].tree;d(a.tag)&&nt(a.tag),e[f].node.parentElement.replaceChild(l,e[f].node),d(a.tag)&&tt(a.tag),e[f].tree=u,e[f].node=l}else{const l=rt(u);if(!l){s++;continue}if(n)t.appendChild(l);else if(e.length===0)o??(o=c.parentElement),o.insertBefore(l,c.nextSibling);else{const a=e[e.length-1].node,at=a.nextSibling;a.parentElement.insertBefore(l,at)}e.push({key:h,tree:u,node:l})}s++}if(e.length>i.length){for(let u=i.length;u<e.length;u++){const h=e[u].tree;d(h.tag)&&nt(h.tag),e[u].node.remove(),d(h.tag)&&tt(h.tag)}e.splice(i.length,e.length-i.length)}n=!1})}function Pt({tag:t,attrs:r,children:e}){const n=b(t,r,e);if(wt(),n instanceof DocumentFragment){const o=n.children[0];x(()=>{o.parentNode&&v()})}else n instanceof HTMLElement&&x(()=>{n.parentNode&&v()});return n}let y="",w,st=!0,I="";function kt(t){y=t.base||"/",/(^\/$|^\/.+\/$)/.test(y)||S("base 必须以 / 开头 / 结尾"),w=t.mode||"history",st=t.isBrowser??!0,I=t.SSR_DATA_KEY||"g_initialProps"}function G(t){if(W(t))return t;t=t;const r=t.path;let e="";for(const c in t.query)e+=`&${c}=${t.query[c]}`;e=e?"?"+e:"";const n=t.hash?"#"+t.hash:"";return r+e+n}function Ct(t){const r={};return t.replace("?","").split("&").forEach(n=>{const[o,c]=n.split("=");o&&c&&(r[o]=c)}),r}function N(t){return t.replace(/\/+/g,"/")}const O=U({path:"",query:{},hash:"",meta:{}});function C(t){const r=new URL(N("http://0.0.0.0/"+t));O.path=r.pathname.replace(y,"/"),O.query=Ct(r.search),O.hash=r.hash}function St(t){const r=G(t);w==="history"?history.pushState({},"",N(y+"/"+r)):location.hash=r,C(r)}function jt(t){const r=G(t);w==="history"?history.replaceState({},"",N(y+"/"+r)):location.hash=r,C(r)}function Mt(t){history.go(t)}function Tt(){return{push:St,replace:jt,go:Mt}}function Nt(t){t.exact??(t.exact=!0);const r=t.component;return p(r,null)}const F=Symbol("Route");Nt.prototype[F]=F;function L(t){return typeof t=="function"&&t.prototype[F]===F}function ut(t,r){const e=t.find(c=>c.attrs.exact||c.attrs.exact===void 0?r===c.attrs.path:(r+"/").startsWith(N(c.attrs.path+"/")));if(!e)return null;const n={tag:"",attrs:{},children:[]};n.tag=e.attrs.component;const o=[ut(e.children,r)].filter(c=>c);if(n.children=o,o.length===0){const c=e.children[e.children.length-1];c&&L(c.tag)&&!c.attrs.path&&(n.children=[$(n,{tag:c.attrs.component})])}if(e.attrs.exact===!1&&n.children.length===0){const c=t[t.length-1];if(c&&L(c.tag)&&!c.attrs.path)return n.tag=c.attrs.component,n}return n}let ot=!0;function ft(t,r=!0){const e=U({tag:"",attrs:{},children:[]});return yt(()=>O.path,async n=>{const o=t.children.filter(i=>g(i)&&L(i.tag)),c=ut(o,n);if(c){r&&typeof c.tag.prototype.getInitialProps=="function"&&(ot&&window[I]?(delete window[I],ot=!1):t.Loading&&(e.tag=t.Loading));for(const i in c)e[i]=c[i]}},{immediate:!0}),{currentTree:e}}function lt(t){const r=t(),e=r.tag;return p(Y,null,()=>p(e,null,r.children[0]&&lt(()=>r.children[0])))}function Ot(t){function r(){return w==="history"?location.href.replace(location.origin+y,""):location.hash.slice(1)}C(r()),window.addEventListener("popstate",()=>{C(r())});const{currentTree:e}=ft(t);return lt(()=>e)}function xt(t){let r="";if(w==="history")r=t.url.replace(y,"");else{const n=t.url.match(/#.*/);r=n?n[0]:""}C(r);const{currentTree:e}=ft({children:t.children,url:r},!1);return p("tier",{tree:()=>e})}function At(t){return p(Y,null,st?p(Ot,{...t}):p(xt,{...t}))}const _t={to:"/",type:"push"};function Ft(t){t=$(_t,t);const r=W(t.to)?t.to:G(t.to),e=N(y+(w==="hash"?"#"+r:r)),n=Tt();function o(c){c.preventDefault(),t.type==="push"?n.push(r):n.replace(r)}return p("a",{href:e,onclick:o},t.children)}export{Ft as L,At as R,Nt as a,p as h,kt as i,Pt as r};
